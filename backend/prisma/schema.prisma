// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENTE
}

enum StatusConversa {
  ABERTO
  EM_ANDAMENTO
  AGUARDANDO
  RESOLVIDO
  FECHADO
}

enum Prioridade {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum StatusAgendamento {
  AGENDADO
  CONFIRMADO
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
  REAGENDADO
}

enum TipoMensagem {
  TEXTO
  IMAGEM
  AUDIO
  VIDEO
  DOCUMENTO
  STICKER
  LOCALIZACAO
  CONTATO
}

// ============================================
// MODELS
// ============================================

model Empresa {
  id              String   @id @default(uuid())
  nome            String
  slug            String   @unique
  descricao       String?
  email           String?
  telefone        String?
  endereco        String?
  logo            String?
  corPrimaria     String?
  corSecundaria   String?
  plano           String?
  limiteUsuarios  Int?
  limiteConversas Int?
  ativo           Boolean  @default(true)
  configuracao    Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  usuarios        Usuario[]
  clientes        Cliente[]
  conversas       Conversa[]
  agendamentos    Agendamento[]
  configuracaoIA  ConfiguracaoIA?

  @@map("empresas")
  @@index([slug])
  @@index([ativo])
}

model Usuario {
  id          String   @id @default(uuid())
  nome        String
  email       String   @unique
  senha       String
  telefone    String?
  avatar      String?
  role        Role
  empresaId   String?
  ativo       Boolean  @default(true)
  ultimoLogin DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  empresa        Empresa?        @relation(fields: [empresaId], references: [id], onDelete: SetNull)
  conversas      Conversa[]      @relation("AgenteConversas")
  mensagens      Mensagem[]      @relation("AgenteMensagens")
  agendamentos   Agendamento[]

  @@map("usuarios")
  @@index([email])
  @@index([empresaId])
  @@index([role])
  @@index([ativo])
}

model Cliente {
  id          String      @id @default(uuid())
  nome        String
  email       String?
  telefone    String?
  avatar      String?
  documento   String?
  endereco    String?
  observacoes String?
  tags        String[]
  ativo       Boolean     @default(true)
  empresaId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relacionamentos
  empresa      Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  conversas    Conversa[]
  agendamentos Agendamento[]

  @@map("clientes")
  @@index([empresaId])
  @@index([email])
  @@index([telefone])
  @@index([ativo])
}

model Conversa {
  id               String          @id @default(uuid())
  titulo           String?
  status           StatusConversa  @default(ABERTO)
  prioridade       Prioridade      @default(MEDIA)
  canal            String
  identificadorCanal String?
  sla              Int?
  tempoResposta    Int?
  satisfacao       Int?
  observacoes      String?
  tags             String[]
  fechadaEm        DateTime?
  empresaId        String
  clienteId        String
  agenteId         String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relacionamentos
  empresa    Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente    Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  agente     Usuario?  @relation("AgenteConversas", fields: [agenteId], references: [id], onDelete: SetNull)
  mensagens  Mensagem[]

  @@map("conversas")
  @@index([empresaId])
  @@index([clienteId])
  @@index([agenteId])
  @@index([status])
  @@index([createdAt])
}

model Mensagem {
  id          String        @id @default(uuid())
  conversaId  String
  conteudo    String?
  tipo        TipoMensagem  @default(TEXTO)
  remetente   String        // 'cliente' ou 'agente'
  isIA        Boolean       @default(false)
  isLida      Boolean       @default(false)
  arquivoUrl  String?
  arquivoTipo String?
  agenteId    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relacionamentos
  conversa Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  agente   Usuario? @relation("AgenteMensagens", fields: [agenteId], references: [id], onDelete: SetNull)

  @@map("mensagens")
  @@index([conversaId, createdAt])
  @@index([isLida])
}

model Agendamento {
  id          String            @id @default(uuid())
  titulo      String
  descricao   String?
  dataHora    DateTime
  duracao     Int               // Duração em minutos
  status      StatusAgendamento @default(AGENDADO)
  tipo        String?
  empresaId   String
  clienteId   String
  agenteId    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relacionamentos
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  agente  Usuario? @relation(fields: [agenteId], references: [id], onDelete: SetNull)

  @@map("agendamentos")
  @@index([empresaId])
  @@index([clienteId])
  @@index([agenteId])
  @@index([dataHora])
  @@index([status])
}

model ConfiguracaoIA {
  id            String   @id @default(uuid())
  empresaId     String   @unique
  promptBase    String   @db.Text
  modelo        String   @default("gpt-4")
  temperatura   Float    @default(0.7)
  maxTokens     Int      @default(1000)
  modoAutomatico Boolean  @default(false)
  idioma        String   @default("pt-BR")
  personalidade String?
  faq           String[]
  palavrasChave String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("configuracao_ia")
}
