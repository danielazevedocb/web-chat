// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum ChatType {
  DIRECT
  GROUP
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  FILE
  EMOJI
}

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENTE
}

enum StatusConversa {
  ABERTO
  EM_ANDAMENTO
  AGUARDANDO
  RESOLVIDO
  FECHADO
}

enum Prioridade {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum Canal {
  webchat
  whatsapp
  telegram
  email
  telefone
}

enum Plano {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum StatusAgendamento {
  AGENDADO
  CONFIRMADO
  CANCELADO
  CONCLUIDO
  AUSENTE
}

enum TipoAgendamento {
  consulta
  reuniao
  suporte
  venda
  outros
}

enum TipoMensagem {
  TEXTO
  IMAGEM
  AUDIO
  VIDEO
  ARQUIVO
  EMOJI
}

enum TipoArquivo {
  IMAGEM
  DOCUMENTO
  AUDIO
  VIDEO
  OUTROS
}

// ============================================
// MODELOS DO SISTEMA MULTI-EMPRESA
// ============================================

model Empresa {
  id              String   @id @default(uuid())
  nome            String
  slug            String   @unique
  descricao       String?
  email           String?
  telefone        String?
  endereco        String?
  logo            String?
  corPrimaria     String?  @default("#3B82F6")
  corSecundaria   String?  @default("#1E40AF")
  plano           Plano    @default(FREE)
  limiteUsuarios  Int      @default(10)
  limiteConversas Int      @default(100)
  ativo           Boolean  @default(true)
  configuracao    Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  usuarios         Usuario[]
  clientes         Cliente[]
  conversas        Conversa[]
  agendamentos     Agendamento[]
  configuracaoIA   ConfiguracaoIA?

  @@index([slug])
  @@index([ativo])
  @@map("empresas")
}

model Usuario {
  id         String   @id @default(uuid())
  nome       String
  email      String   @unique
  senha      String
  telefone   String?
  avatar     String?
  role       Role
  ativo      Boolean  @default(true)
  empresaId  String?
  ultimoLogin DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relacionamentos
  empresa        Empresa?      @relation(fields: [empresaId], references: [id], onDelete: SetNull)
  conversas      Conversa[]
  mensagens      Mensagem[]
  agendamentos   Agendamento[]

  @@index([email])
  @@index([empresaId])
  @@index([role])
  @@map("usuarios")
}

model Cliente {
  id          String   @id @default(uuid())
  nome        String
  email       String?
  telefone    String?
  avatar      String?
  documento   String?
  endereco    String?
  observacoes String?
  tags        String[] @default([])
  ativo       Boolean  @default(true)
  empresaId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  empresa      Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  conversas    Conversa[]
  agendamentos Agendamento[]

  @@index([empresaId])
  @@index([email])
  @@index([telefone])
  @@map("clientes")
}

model Conversa {
  id               String          @id @default(uuid())
  titulo           String
  status           StatusConversa @default(ABERTO)
  prioridade       Prioridade      @default(MEDIA)
  canal            Canal
  identificadorCanal String?       // ID/número do canal (ex: número WhatsApp)
  empresaId        String
  clienteId        String
  agenteId         String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relacionamentos
  empresa     Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente     Cliente      @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  agente      Usuario?     @relation(fields: [agenteId], references: [id], onDelete: SetNull)
  mensagens   Mensagem[]
  arquivos    Arquivo[]

  @@index([empresaId])
  @@index([clienteId])
  @@index([agenteId])
  @@index([status])
  @@map("conversas")
}

model Mensagem {
  id          String        @id @default(uuid())
  conversaId  String
  conteudo    String?
  tipo        TipoMensagem  @default(TEXTO)
  remetente   String        // 'cliente' ou 'agente'
  agenteId    String?
  arquivoUrl  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relacionamentos
  conversa    Conversa      @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  agente      Usuario?      @relation(fields: [agenteId], references: [id], onDelete: SetNull)

  @@index([conversaId, createdAt])
  @@map("mensagens")
}

model ConfiguracaoIA {
  id             String   @id @default(uuid())
  empresaId      String   @unique
  ativo          Boolean  @default(false)
  promptBase     String
  modelo         String   @default("gpt-4")
  temperatura    Float    @default(0.7)
  maxTokens      Int      @default(1000)
  modoAutomatico Boolean  @default(false)
  idioma         String   @default("pt-BR")
  personalidade  String?
  faq            String[]
  palavrasChave  String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacionamentos
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("configuracoes_ia")
}

model Agendamento {
  id          String            @id @default(uuid())
  titulo      String
  descricao   String?
  dataHora    DateTime
  duracao     Int               @default(30) // minutos
  status      StatusAgendamento @default(AGENDADO)
  tipo        TipoAgendamento   @default(consulta)
  empresaId   String
  clienteId   String
  agenteId    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relacionamentos
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  agente  Usuario? @relation(fields: [agenteId], references: [id], onDelete: SetNull)

  @@index([empresaId])
  @@index([clienteId])
  @@index([agenteId])
  @@index([dataHora])
  @@index([status])
  @@map("agendamentos")
}

model Arquivo {
  id           String      @id @default(uuid())
  nome         String
  nomeOriginal String
  url          String
  tipo         TipoArquivo
  tamanho      Int         // bytes
  mimeType     String?
  thumbnail    String?
  conversaId   String?
  mensagemId   String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relacionamentos
  conversa Conversa? @relation(fields: [conversaId], references: [id], onDelete: Cascade)

  @@index([conversaId])
  @@map("arquivos")
}

// ============================================
// MODELOS DO SISTEMA DE CHAT BÁSICO
// ============================================

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  avatar    String?
  bio       String?
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  sentMessages     Message[]
  chatParticipants ChatParticipant[]
  messageReads     MessageRead[]

  @@map("users")
}

model Chat {
  id        String   @id @default(uuid())
  type      ChatType @default(DIRECT)
  name      String?  // Para grupos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  participants ChatParticipant[]
  messages     Message[]

  @@map("chats")
}

model ChatParticipant {
  id         String   @id @default(uuid())
  chatId     String
  userId     String
  role       String   @default("MEMBER") // MEMBER, ADMIN (para grupos)
  joinedAt   DateTime @default(now())
  lastReadAt DateTime?

  // Relacionamentos
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@map("chat_participants")
}

model Message {
  id        String      @id @default(uuid())
  chatId    String
  senderId  String
  content   String?
  type      MessageType @default(TEXT)
  fileUrl   String?
  fileSize  Int?        // Tamanho em bytes
  mimeType  String?
  replyToId String?     // ID da mensagem respondida
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relacionamentos
  chat     Chat         @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender   User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  replyTo  Message?     @relation("MessageReplies", fields: [replyToId], references: [id])
  replies  Message[]    @relation("MessageReplies")
  reads    MessageRead[]

  @@index([chatId, createdAt])
  @@map("messages")
}

model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  // Relacionamentos
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_reads")
}
